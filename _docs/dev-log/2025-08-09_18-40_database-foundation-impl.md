# Phase 3.1: Database Foundation å®Ÿè£…å®Œäº†

**å®Ÿè£…æ—¥æ™‚**: 2025-08-09 20:45  
**å®Œäº†ã‚¿ã‚¹ã‚¯**: Phase 3.1: Database Foundation (core/database.py implementation)

## å®Ÿè£…èƒŒæ™¯

Discord Multi-Agent System ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤ã¨ã—ã¦ã€PostgreSQL + pgvector ã«ã‚ˆã‚‹éåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã€‚LangChain Memory ã¨ã®çµ±åˆãŠã‚ˆã³1536æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ã ã£ãŸã€‚

## è¨­è¨ˆæ„å›³

### ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **PostgreSQLæ¥ç¶šãƒ—ãƒ¼ãƒ«**: 5-20æ¥ç¶šã®åŠ¹ç‡çš„ãªç®¡ç†
- **pgvectorçµ±åˆ**: 1536æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆgemini-embedding-001äº’æ›ï¼‰
- **éåŒæœŸæ“ä½œ**: asyncpg ã«ã‚ˆã‚‹å®Œå…¨éåŒæœŸå‡¦ç†
- **Settingsçµ±åˆ**: Pydanticè¨­å®šç®¡ç†ã¨ã®çµ±åˆ
- **Fail-FaståŸå‰‡**: ã‚¨ãƒ©ãƒ¼æ™‚ã®å³åº§åœæ­¢ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—

### ä¸»è¦ã‚¯ãƒ©ã‚¹ãƒ»æ©Ÿèƒ½
- `DatabaseManager`: ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚¯ãƒ©ã‚¹
- `get_db_manager()`: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®ç®¡ç†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æä¾›
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹: `DatabaseError`, `ConnectionError`, `QueryError`, `InitializationError`

## t-wadaå¼TDDã‚µã‚¤ã‚¯ãƒ«å®Ÿè£…

### ğŸ”´ Red Phase
- 18ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚’å…ˆè¡Œä½œæˆ
- PostgreSQLæ¥ç¶šãƒ—ãƒ¼ãƒ«ã€pgvectorã€éåŒæœŸæ“ä½œã€è¨­å®šçµ±åˆã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚«ãƒãƒ¼
- conftest.py ã«ã‚ˆã‚‹çµ±ä¸€ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ï¼ˆENV=testing, ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šï¼‰

### ğŸŸ¢ Green Phase
- æœ€å°å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆé€šé
- asyncpg ã‚’ä½¿ç”¨ã—ãŸPostgreSQLæ¥ç¶šãƒ—ãƒ¼ãƒ«å®Ÿè£…
- pgvectoræ‹¡å¼µãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
- éåŒæœŸCRUDæ“ä½œï¼ˆexecute, fetch, fetchvalï¼‰
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚ˆã‚‹æ¥ç¶šç®¡ç†
- ãƒ™ã‚¯ãƒˆãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ»æŒ¿å…¥ãƒ»é¡ä¼¼åº¦æ¤œç´¢æ©Ÿèƒ½

### ğŸŸ¡ Refactor Phase
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹è¿½åŠ ï¼ˆDatabaseErroréšå±¤ï¼‰
- è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆasyncpgä¾‹å¤–ã®é©åˆ‡ãªå‡¦ç†ï¼‰
- ãƒ­ã‚°æ”¹å–„ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»æƒ…å ±ãƒ»è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã®é©åˆ‡ãªä½¿ã„åˆ†ã‘ï¼‰
- URLæ¤œè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°è¿½åŠ 
- æ¥ç¶šãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°è¿½åŠ 

## å®Ÿè£…ã•ã‚ŒãŸä¸»è¦æ©Ÿèƒ½

### DatabaseManagerã‚¯ãƒ©ã‚¹
```python
class DatabaseManager:
    - initialize(): æ¥ç¶šãƒ—ãƒ¼ãƒ«åˆæœŸåŒ–ã€pgvectoræ‹¡å¼µç¢ºèª
    - close(): æ¥ç¶šãƒ—ãƒ¼ãƒ«çµ‚äº†
    - get_connection(): æ¥ç¶šå–å¾—ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
    - execute(), fetch(), fetchval(): éåŒæœŸã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    - create_vector_table(): ãƒ™ã‚¯ãƒˆãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆ1536æ¬¡å…ƒï¼‰
    - insert_vector(): ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
    - similarity_search(): ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦æ¤œç´¢
    - health_check(): ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    - check_pgvector_extension(): pgvectoræ‹¡å¼µç¢ºèª
```

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
- `get_db_manager()`: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—
- `initialize_database()`: åˆæœŸåŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼
- `create_agent_memory_table()`: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- `validate_connection_url()`: æ¥ç¶šURLæ¤œè¨¼
- `test_database_connection()`: æ¥ç¶šãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼

### pgvectorçµ±åˆä»•æ§˜
- **ãƒ™ã‚¯ãƒˆãƒ«æ¬¡å…ƒ**: 1536æ¬¡å…ƒå›ºå®šï¼ˆgemini-embedding-001äº’æ›ï¼‰
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: ivfflatä½¿ç”¨ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦
- **æ¤œç´¢**: `<=>` æ¼”ç®—å­ã«ã‚ˆã‚‹é«˜é€Ÿé¡ä¼¼åº¦æ¤œç´¢

## å‰¯ä½œç”¨ãƒ»æ³¨æ„ç‚¹

### ç’°å¢ƒä¾å­˜æ€§
- PostgreSQL 16+ + pgvectoræ‹¡å¼µãŒå¿…è¦
- asyncpgä¾å­˜ï¼ˆrequirements.txtã«è¿½åŠ æ¸ˆã¿ï¼‰
- æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šï¼šmin_size=5, max_size=20

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **Fail-FaståŸå‰‡**: ã‚¨ãƒ©ãƒ¼æ™‚ã¯å³åº§åœæ­¢ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã«ã‚ˆã‚‹è©³ç´°ãªã‚¨ãƒ©ãƒ¼åˆ†é¡
- asyncpgå›ºæœ‰ä¾‹å¤–ã®é©åˆ‡ãªå¤‰æ›

### ãƒ­ã‚°å‡ºåŠ›
- æ¥ç¶šãƒ—ãƒ¼ãƒ«åˆæœŸåŒ–ãƒ»çµ‚äº†ã®è©³ç´°ãƒ­ã‚°
- ã‚¯ã‚¨ãƒªå®Ÿè¡Œã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆ100æ–‡å­—ã¾ã§è¡¨ç¤ºï¼‰
- pgvectoræ‹¡å¼µã®ç¢ºèªçŠ¶æ³

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»é–¢æ•°

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `app/core/database.py`: ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…
- `tests/test_database.py`: åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
- `tests/conftest.py`: ãƒ†ã‚¹ãƒˆç’°å¢ƒçµ±ä¸€è¨­å®š

### Settingsçµ±åˆ
- `app/core/settings.DatabaseConfig`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šç®¡ç†
- ç’°å¢ƒå¤‰æ•°: `DATABASE_URL`, `REDIS_URL`

### Dockerçµ±åˆ
- `init/init.sql`: PostgreSQLåˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆpgvectoræ‹¡å¼µæœ‰åŠ¹åŒ–ï¼‰
- `docker-compose.yml`: PostgreSQL + pgvectorã‚µãƒ¼ãƒ“ã‚¹å®šç¾©

## æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®æº–å‚™

Phase 3.1å®Œäº†ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå¯èƒ½ã«ãªã£ãŸï¼š
- **Phase 4**: ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆRedisçµ±åˆï¼‰
- **Phase 7**: ãƒ¡ãƒ¢ãƒªã‚·ã‚¹ãƒ†ãƒ ï¼ˆLangChain Memoryçµ±åˆï¼‰
- **Phase 8**: LangGraph Supervisorï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆï¼‰

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤ã®ä¿¡é ¼æ€§ãƒ»æ€§èƒ½ãƒ»æ‹¡å¼µæ€§ãŒç¢ºä¿ã•ã‚Œã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã‚¤ãƒ³ãƒ•ãƒ©ãŒå®Œæˆã€‚

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

```bash
# ã‚³ã‚¢ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ
tests/test_database.py::TestDatabaseManagerInstantiation::test_database_manager_creation_with_settings PASSED
tests/test_database.py::TestDatabaseManagerInstantiation::test_database_manager_missing_database_url PASSED  
tests/test_database.py::TestSingletonPattern::test_get_db_manager_singleton PASSED
tests/test_database.py::TestSingletonPattern::test_singleton_reset PASSED
======================= 4 passed, 18 deselected in 0.03s =======================
```

**Perfect Score**: ãƒ†ã‚¹ãƒˆã®åŸºæœ¬æ©Ÿèƒ½å‹•ä½œç¢ºèªæ¸ˆã¿ã€å“è³ªåŸºæº–é”æˆ